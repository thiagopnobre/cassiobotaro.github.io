<!DOCTYPE html>
<html lang="pt" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Mais um passo com web2py - import None</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://cassiobotaro.github.io/mais-um-passo-com-web2py.html">

        <meta name="author" content="Cássio Botaro" />
        <meta name="keywords" content="web2py,iniciantes" />
        <meta name="description" content="Após escrever o hello world, é hora de dar mais alguns passos com web2py." />

        <meta property="og:site_name" content="import None" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Mais um passo com web2py"/>
        <meta property="og:url" content="http://cassiobotaro.github.io/mais-um-passo-com-web2py.html"/>
        <meta property="og:description" content="Após escrever o hello world, é hora de dar mais alguns passos com web2py."/>
        <meta property="article:published_time" content="2015-07-07" />
            <meta property="article:section" content="web2py" />
            <meta property="article:tag" content="web2py" />
            <meta property="article:tag" content="iniciantes" />
            <meta property="article:author" content="Cássio Botaro" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://cassiobotaro.github.io/theme/css/bootstrap.united.min.css" type="text/css"/>
    <link href="http://cassiobotaro.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://cassiobotaro.github.io/theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="http://cassiobotaro.github.io/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://cassiobotaro.github.io/" class="navbar-brand">
import None            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://cassiobotaro.github.io/category/python.html">Python</a>
                        </li>
                        <li >
                            <a href="http://cassiobotaro.github.io/category/python3.html">Python3</a>
                        </li>
                        <li >
                            <a href="http://cassiobotaro.github.io/category/sublime.html">Sublime</a>
                        </li>
                        <li class="active">
                            <a href="http://cassiobotaro.github.io/category/web2py.html">Web2py</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://cassiobotaro.github.io/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://cassiobotaro.github.io/mais-um-passo-com-web2py.html"
                       rel="bookmark"
                       title="Permalink to Mais um passo com web2py">
                        Mais um passo com web2py
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-07-07T00:00:00-03:00"> Ter 07 julho 2015</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="http://cassiobotaro.github.io/tag/web2py.html">web2py</a>
        /
	<a href="http://cassiobotaro.github.io/tag/iniciantes.html">iniciantes</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p><img alt="Web2py Logo" src="../images/web2py_logo.png" /></p>
<h2>Recapitulando</h2>
<p>No <a href="http://cassiobotaro.github.io/introducao-ao-web2py.html">post</a> anterior dei uma introdução sobre o que é o web2py e iniciamos a construção de uma aplicação, porém não através de um scaffolding(uma aplicação base).</p>
<p>Escrevemos um hello world personalizado onde o nome passado por argumento era retornado no corpo do retorno da nossa aplicação.</p>
<p><img alt="print" src="../images/print_screen_hello.png" /></p>
<h2>O próximo passo</h2>
<p>Ainda sem uma aplicação bem definida decidi aboradar um pouco da criação de um modelo e sua aplicação.</p>
<p>Este será então o nosso segundo hello world, criaremos um modelo, faremos sua exposição através da view e seu controle através de um controlador. Será dado uma pincelada como ter visões alternativas sobre o mesmo controlador.</p>
<h2>Definindo o modelo</h2>
<p>Crie um arquivo dentro do diretório models chamado db.py com o seguinte conteúdo:</p>
<div class="highlight"><pre><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span>
    <span class="s">&#39;marcas&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s">&#39;nome&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span>
    <span class="s">&#39;carros&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s">&#39;modelo&#39;</span><span class="p">,</span> <span class="n">notnull</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s">&#39;ano&#39;</span><span class="p">,</span> <span class="n">notnull</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s">&#39;marca&#39;</span><span class="p">,</span> <span class="s">&#39;reference marcas&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>


<p>Agora temos definidos dois modelos de nossa aplicação, lembrando que estes modelos serão aplicados à <a href="http://web2py.com/books/default/chapter/29/07/forms-and-validators#SQLFORM">visão</a> e a persistência de dados.</p>
<p>O que acabamos de definir é que utilizaremos o sqlite como banco de dados, e neste banco de dados temos duas tabelas onde serão armazenados nossos dados.</p>
<p>Em uma delas temos uma lista de marcas, e em outra uma lista de carros asosociados a estas marcas. todo carro deve possuir obrigatoriamente modelo, ano e marca.</p>
<h2>Populando nossas tabelas</h2>
<p>Ainda no arquivo db.py adicione as seguintes linhas:</p>
<div class="highlight"><pre><span class="c"># verifica se a tabela de marcas está vazia</span>
<span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">marcas</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">marcas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nome</span><span class="o">=</span><span class="s">&#39;Fiat&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">marcas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nome</span><span class="o">=</span><span class="s">&#39;Ford&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">marcas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nome</span><span class="o">=</span><span class="s">&#39;Chevrolet&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c"># verifica se a tabela de carros está vazia</span>
<span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">carros</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">carros</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">modelo</span><span class="o">=</span><span class="s">&#39;Idea&#39;</span><span class="p">,</span> <span class="n">marca</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ano</span><span class="o">=</span><span class="s">&#39;2003&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">carros</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">modelo</span><span class="o">=</span><span class="s">&#39;Ka&#39;</span><span class="p">,</span> <span class="n">marca</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ano</span><span class="o">=</span><span class="s">&#39;2004&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">carros</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">modelo</span><span class="o">=</span><span class="s">&#39;Celta&#39;</span><span class="p">,</span> <span class="n">marca</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ano</span><span class="o">=</span><span class="s">&#39;2005&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>


<p>Temos 3 carros de 3 marcas distintas. Preste atenção no if que foi adicionado antes da inserção do carro, ele previne que a cada requisição carros repetidos sejam adicionados à tabela.</p>
<p>Lembre-se tambem que essa maneira de povoar os dados é somente para desenvolvimento e teste e pode ser apagado após os registros serem adicionados ao banco de dados. Apagar estas linhas evita duas consultas desnecessárias ao banco de dados.</p>
<h2>Controlando o que será exibido</h2>
<p>Vamos voltar ao nosso controlador, o arquivo default.py(hello/controllers/default.py)</p>
<p>Já vimos que o controlador recebe uma requisição, realiza processamento e retorna alguma resposta ao solicitante.
Vamos então apagar o conteúdo de index e reescreve-lo agora consultando os carros existentes em meu banco de dados.</p>
<p>O código será o seguinte:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="c"># pode ser traduzido como select * from carros</span>
    <span class="c"># ou seja, todos os carros na tabela</span>
    <span class="n">carros</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">carros</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="c"># dicionário que define as variáveis presentes no ambiente </span>
    <span class="c"># durante renderização da template html</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;carros&#39;</span><span class="p">:</span> <span class="n">carros</span><span class="p">}</span>
</pre></div>


<p>Com essa alteração nossa visão também deve ser alterada. Para uma vizualização interessante vamos fazer uma tabela.
Edite o arquivo index.html(hello/views/default/index.html)</p>
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;pt-br&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Carros<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;table&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>Modelo<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Marca<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Ano<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        {{for carro in carros:}}
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{=carro.modelo}}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{=carro.marca.nome}}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{=carro.ano}}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        {{pass}}
    <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>Um único detalhe que chamo atenção neste codigo é <code>{{=carro.marca.nome}}</code>, como as tabelas possuem relação o web2py irá ficar responsável por  buscar o nome do modelo de cada carro.
Visualize através da url: <a href="http://localhost:8000/hello/default/index.json">http://localhost:8000/hello/default/index.json</a></p>
<h2>Exibindo os mesmos dados de forma diferente</h2>
<p>Já que temos uma resposta html, o quão será difícil retornar um json
com estes mesmos dados para uma possível comunicação entre sistemas ou at´e mesmo para consumo de um aplicativo móvel?</p>
<p>Na verdade é extremamente simples. Apenas crie no mesmo diretório onde se encontra a view index.html um arquivo index.json com o seguinte conteúdo.</p>
<div class="highlight"><pre>{{from gluon.serializers import json}}{{=XML(json(response._vars))}}
</pre></div>


<p>Para consultar visite a url: <a href="http://localhost:8000/hello/default/index.json">http://localhost:8000/hello/default/index.json</a></p>
<h2>Em breve tem mais...</h2>
<p>Ficou curioso sobre o esquema de templates do web2py?, mais detalhes sobre os modelos? Ainda um pouco perdido? Não se preocupe.
Pretendo em breve escreves posts mais detalhados sobre cada aspecto do web2py como modelo, visão, controlador, modulos e também tratar brechas que até agora foram deixadas.</p>
<p>Curtiu? Compartilhe!</p>
<p>[ ]'s</p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    </div>
    <!-- AddThis Button END -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'importnone'; // required: replace example with your forum shortname

                    var disqus_identifier = 'mais-um-passo-com-web2py';
                var disqus_url = 'http://cassiobotaro.github.io/mais-um-passo-com-web2py.html';

            var disqus_config = function () {
                this.language = "pt";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="http://www.gravatar.com/avatar/a19c2dcbc9fc6ae1c340528186320d9c?s=100"/>
        </p>
    <p>
        <strong>About Cássio Botaro</strong><br/>
        WebDeveloper at Diarios Associados. UHlzc2lvbmF0ZSB3ZWJkZXZlbG9wZXIuCg==
    </p>
</div>
<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/cassiobotaro"><i class="fa fa-github-square fa-lg"></i> github</a></li>
                <li class="list-group-item"><a href="http://twitter.com/cassiobotaro"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
                <li class="list-group-item"><a href="https://plus.google.com/u/0/+C%C3%A1ssioBotaro"><i class="fa fa-google-plus-square fa-lg"></i> google-plus</a></li>
                <li class="list-group-item"><a href="http://br.linkedin.com/pub/c%C3%A1ssio-botaro/b1/43/6a2"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="http://cassiobotaro.github.io/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                </ul>
            </li>



    <li class="list-group-item"><h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/cassiobotaro">@cassiobotaro</a> on GitHub
    </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 Cássio Botaro
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://cassiobotaro.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://cassiobotaro.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://cassiobotaro.github.io/theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'http://cassiobotaro.github.io/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'cassiobotaro',
                count: 3,
                skip_forks: true,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="http://cassiobotaro.github.io/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'importnone'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-59964005-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

        <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-54023148366c6bdd"></script>
</body>
</html>